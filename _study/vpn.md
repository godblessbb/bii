# 

# 如何在一分钟之内搭建一个VPN

## 前情

不知不觉，一直在用的VPN在昨天过期了。由于笔者的毛躁和大意，这种忘记续费的情况基本上每年都能遇上百八十回。每次状况发生都是伤害不大，麻烦不小，由于众所周知的原因，这类VPN的充值网站经常性地被迫流亡，一旦续费不及时很可能就会遇到要给已经过期的VPN续费你需要先有一个VPN的哲学之问。求人借账号又显得太low，今次终于找到了一个可以一劳永逸解决问题的办法。只要有一台境外服务器，只需要较少的配置很少的时间就可以实现个人IPsec VPN的应急搭建。这个方案的优点是搭建快速简单，并且可靠，只要我们还可以用信用卡购买到境外的服务器（阿里云腾讯云等也提供境外服务器），你就永远有机会给你的梯子续命。


## 准备工作

动手前你需要准备以下工具：

- 一台境外服务器
- 在服务器上安装Docker


## 动手搭建服务端

### 1.规划VPN配置信息

如果没有安装Docker请在这部开始前自行安装，Docker是一个流行的容器化平台，可以更方便地搭建、管理和部署应用程序。这里假定你已经安装好了Docker。


#### 1.1创建一个配置文件

在服务器的任意一个位置，创建一个配置文件。如，你可以在根目录下创建一个文件夹为/data/jump/vpn/，在此文件夹里创建一个.env文件。配置文件的完整路径为/data/jump/vpn/.env


#### 1.2填写配置信息

打开.env文件，按照下面的格式填写必要的信息，填写示例如下：

```
VPN_IPSEC_PSK=password1!
# 配置用于登陆VPN的账号和密码
VPN_USER=vpn
VPN_PASSWORD=vpn1234
# 如下应该填写本机的外网IP（服务器ip）
VPN_PUBLIC_IP=36.111.179.*
# 配置额外的用户名和密码
VPN_ADDL_USERS=vpn1 vpn2
VPN_ADDL_PASSWORDS=vpn11234 pass21234
#DNS配置
VPN_DNS_SRV1=8.8.8.5
VPN_DNS_SRV2=114.114.114.114
```


#### 1.3启动VPN

在终端里执行：
```docker run \```

然后逐行填入以下信息：
```
--name ipsec-vpn-server \
--env-file /data/jump/vpn/.env \ 
--restart=always \
-p 500:500/udp \
-p 4500:4500/udp \
-v /lib/modules:/lib/modules:ro \
-d --privileged \
hwdsl2/ipsec-vpn-server
```
在上述命令中，我们使用了hwdsl2/ipsec-vpn-server这个Docker镜像，并且指定在vpn.env文件中设置环境变量。其中，我们将UDP端口号500和4500分别映射到主机的对应端口，让客户端能够与VPN服务器建立隧道。


#### 1.4VPN状态切换和查看

经过上面的操作，VPN的服务器端就已经搭建成功了。以下几个指令可以查看服务器的运行状态并可以在服务器端自由打开或关闭VPN。
- 查看VPN连接信息使用以下命令：
```docker logs -f ipsec-vpn-server```
- 查看客户端连接情况使用以下命令：
```docker exec -it ipsec-vpn-server ipsec whack --trafficstatus```
- 停止VPN服务使用以下命令：
```docker stop ipsec-vpn-server```
- 重启VPN服务使用以下命令：
```docker start ipsec-vpn-server```



## 配置客户端

服务器端搭建成功以后就可以在手机或电脑上配置客户端信息。这个过程相当简单，甚至都不需要下载任何客户端程序。
以Mac为例，打开系统偏好设置>网络，点击左下角＋号，接口选择VPN，类型选择Cisco IPSec，服务名称随便填。
创建成功后，比照.env文件，进一步填写配置信息如ip地址、用户名和密码，点击认证设置，在共享密钥那里填入PSK信息。
点击连接，大功告成。

我用的是Linode新加坡服务器，带宽只有1M，通过Mac访问油管也是超快。要不是有切换IP的需求，一直用自己的服务器作VPN也不是不可以。


## 关于安全的思考

由于主要意图是作为一个临时桥接的服务器，所以充值以后我就把IPSec Sever关掉了。搭建IPsec VPN Server不再需要复杂的配置，通过Docker我们可以快速实现，并且有更好的可移植性和管理性。在这个过程中，安全性和隐私保护依然是至关重要的需求。因此，我们需要在实现快速搭建的同时，仔细考虑VPN服务器设置和保护工作，以下是一些建议：

- 不要照搬前文提供的任何设置信息，包括配置文件的路径，用户名密码PSK等
- 在不使用的时候记得关掉IPSec服务，以防被黑客控制和利用
- 使用密码强度高的登录密码和PSK，尽量提高破解难度
- 安全组和权限管理


以上。
